# Base image
FROM kalilinux/kali-rolling

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TERM=xterm-256color

# Do APT update and system upgrade, then clean up
RUN apt-get -y update --fix-missing \
    && apt-get -y dist-upgrade \
    && apt-get -y autoremove \
    && apt-get clean

# Install system essentials, networking, and security tools
RUN apt-get install -y \
    build-essential \
    curl \
    file \
    git \
    openvpn \
    bridge-utils \
    net-tools \
    seclists \
    metasploit-framework \
    nmap \
    zsh \
    tmux \
    neovim \
    libpcap-dev \
    libcurl4-openssl-dev \
    sudo \
    python3-pip \
    golang \
    wpscan \
    && apt-get clean

# Uncomment Ruby for WPScan installation
# Install Ruby for WPScan
RUN apt-get install -y ruby-full && apt-get clean

# Create a new user 'cybertech' and add to sudoers
RUN adduser --quiet --disabled-password --shell /bin/bash --home /home/cybertech --gecos "User" cybertech \
    && echo "cybertech:password" | chpasswd \
    && usermod -aG sudo cybertech

# Set Zsh as the default shell for the new user
RUN chsh -s $(which zsh) cybertech

# Copy necessary VPN and tunneling files (OVPN config and tunnel script) and set permissions
COPY enable-tunnel.sh /home/cybertech/
COPY .tmux.conf /home/cybertech/.tmux.conf

# Make the tunnel script executable
RUN chmod +x /home/cybertech/enable-tunnel.sh

# Switch to new user
USER cybertech
WORKDIR /home/cybertech

# Clone custom Neovim configuration from your GitHub repo
RUN git clone https://github.com/Hadiasemi/hadi-kickstart.nvim.git "${XDG_CONFIG_HOME:-$HOME/.config}"/nvim

# Pre-install Lazy.nvim plugins by running Neovim headlessly
RUN nvim --headless "+Lazy! sync" +qa

# Set Go environment variables (fixed key=value format)
ENV GOPATH=/home/cybertech/go
ENV PATH=/usr/local/go/bin:$PATH

# Add Go paths to .zshrc for persistent Go environment setup
RUN echo 'export GOPATH=$HOME/go' >> /home/cybertech/.zshrc \
    && echo 'export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin' >> /home/cybertech/.zshrc

# Install Go-based tools (httpx, subfinder, katana, notify, naabu, asnmap, alterx)
RUN go install github.com/projectdiscovery/httpx/cmd/httpx@latest \
    && go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest \
    && go install github.com/projectdiscovery/katana/cmd/katana@latest \
    && go install github.com/projectdiscovery/notify/cmd/notify@latest \
    && go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest \
    && go install github.com/projectdiscovery/asnmap/cmd/asnmap@latest \
    && go install github.com/projectdiscovery/alterx/cmd/alterx@latest \
    && go install -v github.com/tomnomnom/anew@latest \
    && go install github.com/lc/gau/v2/cmd/gau@latest \
    && go install github.com/Hadiasemi/favfreak@latest

# Clone and set up check_mdi tool
RUN git clone https://github.com/expl0itabl3/check_mdi.git /home/cybertech/check_mdi \
    && cd /home/cybertech/check_mdi \
    && pip3 install -r requirements.txt --break-system-packages 

# Set entrypoint to zsh by default
ENTRYPOINT ["/bin/zsh"]

